<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Reporting Form</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background-color: #f4f4f9; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; color: #666; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn-send { width: 100%; padding: 15px; background-color: #1DB446; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-send:disabled { background-color: #ccc; }
        .btn-edit { width: 100%; padding: 12px; background-color: #ffffff; color: #333; border: 1px solid #ccc; border-radius: 8px; margin-top: 10px; font-weight: bold; cursor: pointer; }
        #preview-section { display: none; }
        .preview-box { background: #f9fffb; border: 2px dashed #1DB446; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .preview-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        #loading { display: none; text-align: center; margin-top: 20px; color: #1DB446; font-weight: bold; }
    </style>
</head>
<body>

    <div class="card">
        <div id="form-section">
            <h3 style="color:#1DB446; margin-top:0;">Submit Expense</h3>
            <div class="form-group"><label>Bill No.</label><input type="text" id="billNo" placeholder="Ex: SU260101"></div>
            <div class="form-group"><label>Item No.</label><input type="text" id="itemNo" placeholder="1"></div>
            
            <div class="form-group">
                <label>Type</label>
                <input list="type-options" id="itemType" placeholder="Select or type...">
                <datalist id="type-options">
                    <option value="Sofa">
                    <option value="Armchair">
                    <option value="Chair">
                    <option value="Table">
                    <option value="Coffee Table">
                    <option value="Side Table">
                    <option value="Bed">
                    <option value="Bench">
                    <option value="Night Table">
                    <option value="Daybed/Ottoman/Stool">
                    <option value="Console Cabinet">
                    <option value="Desk">
                    <option value="Bookcase">
                    <option value="Pillow">
                    <option value="Others">
                </datalist>
            </div>

            <div class="form-group"><label>Description</label><input type="text" id="desc" placeholder="à¹‚à¸„à¸£à¸‡à¹€à¸à¹‰à¸²à¸­à¸µà¹‰"></div>
            <div class="form-group"><label>Supplier</label><input type="text" id="supplier" placeholder="à¸Šà¹ˆà¸²à¸‡A"></div>
            <div class="form-group"><label>Installment</label><input type="text" id="instNo" placeholder="1/2"></div>
            <div class="form-group"><label>Amount</label><input type="number" step="0.01" id="amount" placeholder="+/-0.00"></div>
            <button class="btn-send" onclick="showPreview()">Review Details</button>
        </div>

        <div id="preview-section">
            <h3 style="color:#1DB446; margin-top:0;">Confirm Details</h3>
            <div class="preview-box">
                <div class="preview-row"><span>Bill No:</span><strong id="p-bill"></strong></div>
                <div class="preview-row"><span>Item No:</span><strong id="p-item"></strong></div>
                <div class="preview-row"><span>Type:</span><strong id="p-type"></strong></div>
                <div class="preview-row"><span>Description:</span><strong id="p-desc"></strong></div>
                <div class="preview-row"><span>Supplier:</span><strong id="p-supplier"></strong></div>
                <div class="preview-row"><span>Installment:</span><strong id="p-inst"></strong></div>
                <div class="preview-row"><span>Amount:</span><strong id="p-amount" style="color:#1DB446;"></strong></div>
            </div>
            <button id="confirmBtn" class="btn-send" onclick="confirmAndSend()">Confirm & Send</button>
            <button id="backBtn" class="btn-edit" onclick="goBack()">Go Back & Edit</button>
        </div>

        <div id="loading">Processing... Please wait.</div>
    </div>

    <script>
        const CONFIG = {
            liffId: "2009003342-DR5kmBIl",
            scriptUrl: "https://script.google.com/macros/s/AKfycby17s2vUqmaLRg8NUmBi2C4XIIVciDRXFHviGYYiTiVl6v9ieLd0i7K-EC63s4ph3ZAIQ/exec"
        };

        async function main() {
            try {
                await liff.init({ liffId: CONFIG.liffId });
                if (!liff.isLoggedIn()) liff.login();
            } catch (err) { console.error("LIFF Init failed", err); }
        }
        main();

        function showPreview() {
            const bill = document.getElementById('billNo').value;
            const amount = document.getElementById('amount').value;

            if (!bill || !amount) {
                alert("Please enter Bill No and Amount");
                return;
            }

            document.getElementById('p-bill').innerText = bill;
            document.getElementById('p-item').innerText = document.getElementById('itemNo').value || "-";
            document.getElementById('p-type').innerText = document.getElementById('itemType').value || "-";
            document.getElementById('p-desc').innerText = document.getElementById('desc').value || "-";
            document.getElementById('p-supplier').innerText = document.getElementById('supplier').value || "-";
            document.getElementById('p-inst').innerText = document.getElementById('instNo').value || "-";
            document.getElementById('p-amount').innerText = "à¸¿" + parseFloat(amount).toLocaleString(undefined, {minimumFractionDigits: 2});

            document.getElementById('form-section').style.display = 'none';
            document.getElementById('preview-section').style.display = 'block';
        }

        function goBack() {
            document.getElementById('form-section').style.display = 'block';
            document.getElementById('preview-section').style.display = 'none';
        }

        async function confirmAndSend() {
            document.getElementById('confirmBtn').disabled = true;
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            const bill = document.getElementById('billNo').value;
            const item = document.getElementById('itemNo').value || "-";
            const type = document.getElementById('itemType').value || "-";
            const desc = document.getElementById('desc').value || "-";
            const supplier = document.getElementById('supplier').value || "-";
            const inst = document.getElementById('instNo').value || "-";
            const amount = document.getElementById('amount').value;
            const refCode = Math.random().toString(36).substring(2, 6).toUpperCase();

            const payload = {
                authKey: "PNGL",
                refCode: refCode,
                bill: bill,
                item: item,
                type: type, // New column
                desc: desc,
                supplier: supplier,
                inst: inst,
                amount: amount
            };

            try {
                await fetch(CONFIG.scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                });

                const textMessage = `ðŸ“‹ *New Expense Submitted*\n\n` +
                                    `â€¢ Bill No: ${bill}\n` +
                                    `â€¢ Item No: ${item}\n` +
                                    `â€¢ Type: ${type}\n` +
                                    `â€¢ Desc: ${desc}\n` +
                                    `â€¢ Supplier: ${supplier}\n` +
                                    `â€¢ Installment: ${inst}\n` +
                                    `â€¢ Amount: à¸¿${parseFloat(amount).toLocaleString()}\n` +
                                    `â€¢ Ref: ${refCode}`;

                if (liff.isInClient()) {
                    await liff.sendMessages([{ type: 'text', text: textMessage }, { type: 'text', text: refCode }]);
                    document.getElementById('loading').innerText = "Success! Closing...";
                    setTimeout(() => { liff.closeWindow(); }, 1500);
                } else {
                    document.getElementById('loading').innerText = "Sent Successfully!";
                    alert("Form Submitted Successfully!");
                }
            } catch (err) {
                alert("Error: " + err.message);
                document.getElementById('confirmBtn').disabled = false;
                document.getElementById('loading').style.display = 'none';
            }
        }
    </script>
</body>
</html>
